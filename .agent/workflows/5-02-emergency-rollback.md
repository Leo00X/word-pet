---
description: 紧急回滚流程
---

# 紧急回滚工作流

## 使用场景
生产环境出现严重Bug、数据安全问题、应用不可用等紧急情况

---

## 🚨 回滚决策

### 何时需要回滚？

| 情况 | 严重程度 | 是否回滚 |
|------|---------|---------|
| 应用无法启动 | 🔴 严重 | ✅ 立即回滚 |
| 数据丢失风险 | 🔴 严重 | ✅ 立即回滚 |
| 核心功能不可用 | 🔴 严重 | ✅ 立即回滚 |
| 严重性能下降 | 🟡 中等 | ⚠️ 考虑回滚 |
| UI 显示问题 | 🟢 轻微 | ❌ 热修复 |

---

## 📋 回滚流程

### Step 1: 确认问题严重程度

**快速评估**:
- 影响范围：所有用户 / 部分用户 / 个别用户
- 数据安全：是否有数据丢失风险
- 可用性：核心功能是否完全不可用

**决策**:
```
严重程度 = 高 && 影响范围 = 广
→ 立即回滚，不等修复
```

---

### Step 2: Git 回滚到稳定版本

**查看最近提交**:
```bash
git log --oneline -n 10
```

**找到最后一个稳定版本**:
```bash
# 查看某个commit的详情
git show <commit-hash>

# 确定稳定版本（如 abc1234）
```

**回滚方式 A: 创建回退commit**:
```bash
# 推荐方式（保留历史）
git revert HEAD --no-edit

# 或回退到特定版本
git revert HEAD~3..HEAD --no-edit
```

**回滚方式 B: 硬回退** (谨慎):
```bash
# 本地回退
git reset --hard abc1234

# 强制推送（需要权限）
git push --force
```

---

### Step 3: 快速测试验证

**测试清单**:
- [ ] 应用能正常启动
- [ ] 核心功能可用
- [ ] 数据加载正常
- [ ] 无明显错误

**快速测试脚本**:
```bash
# 编译
npm run build:app

# 真机测试
# 安装到测试设备
# 验证核心功能
```

---

### Step 4: 重新发布

**uni-app 发布**:
```bash
# 打包
HBuilderX → 发行 → 原生App-云打包

# 或使用 CLI
vue-cli-service uni-build --platform app-plus
```

**发布到应用商店**:
- 上传新版本
- 标记为"紧急修复"
- 加快审核（如有渠道）

---

### Step 5: 用户通知

**应用内通知**:
```javascript
// 紧急公告
uni.showModal({
  title: '系统通知',
  content: '检测到版本异常，请立即更新到最新版本',
  showCancel: false,
  success: () => {
    // 跳转到更新页面
  }
});
```

**推送通知** (如有):
```javascript
// 使用推送服务
uni.push.sendMessage({
  title: '紧急更新',
  content: '请立即更新应用至最新版本',
  payload: {
    type: 'force_update'
  }
});
```

---

### Step 6: 创建跟踪 Issue

**在 BUG.md 创建特殊条目**:

```markdown
### #xxx 【回滚】严重Bug导致版本回退

**回滚时间**: 2025-12-06 23:00
**回滚版本**: v2.0.1 → v1.9.5
**影响用户**: 100%
**严重程度**: 🔴 致命
**状态**: 修复中

**问题描述**:
[详细描述导致回滚的问题，包括现象和影响]

**回滚原因**:
- 应用无法启动（闪退）
- 所有用户无法使用
- 尝试热修复失败

**根本原因**:
[5 Whys 分析]
1. 为什么应用闪退？ → 因为 XX 模块初始化失败
2. 为什么初始化失败？ → 因为依赖 YY 数据不存在
3. 为什么数据不存在？ → 因为没有做数据迁移
4. 为什么没做迁移？ → 因为测试时没有覆盖升级场景
5. 为什么没覆盖？ → 因为测试清单不完整 ← 根本原因

**修复计划**:
- [ ] 1. 添加数据迁移逻辑（负责人: XX，截止: 12-08）
- [ ] 2. 增加升级测试用例（负责人: YY，截止: 12-08）
- [ ] 3. Code Review（审查人: ZZ，截止: 12-09）
- [ ] 4. 灰度发布 10%（截止: 12-10）
- [ ] 5. 全量发布（截止: 12-11）

**预防措施**:
- [ ] 更新测试清单，添加"升级场景测试"
- [ ] 建立灰度发布机制
- [ ] 发布前必须跑完整测试套件

**负责人**: [姓名]
**预计修复**: 2025-12-11
```

---

### Step 7: 事后复盘会议

**会议时间**: 回滚后 24 小时内

**参与人员**:
- 开发负责人
- 测试负责人
- 产品负责人
- 运维负责人（如有）

**会议模板**:

```markdown
# 回滚事件复盘会议 - 2025-12-07

## 1. 时间线回顾

| 时间 | 事件 | 责任人 |
|------|------|--------|
| 12-06 18:00 | v2.0.1 发布 | 开发 |
| 12-06 18:30 | 收到用户反馈闪退 | 客服 |
| 12-06 19:00 | 确认问题严重，决定回滚 | 产品 |
| 12-06 19:30 | 完成回滚到 v1.9.5 | 运维 |
| 12-06 20:00 | 通知用户更新 | 客服 |

## 2. 问题根因（5 Whys）

[从 Step 6 复制过来]

## 3. 做得好的地方

- ✅ 快速识别问题（30分钟）
- ✅ 决策果断（不拖延）
- ✅ 回滚执行迅速（30分钟）

## 4. 需要改进的地方

- ❌ 测试不充分（未覆盖升级场景）
- ❌ 没有灰度发布（直接全量）
- ❌ 监控告警不及时

## 5. Action Items

| 任务 | 负责人 | 截止日期 | 优先级 |
|------|--------|---------|--------|
| 建立灰度发布机制 | 运维 | 12-20 | 高 |
| 完善测试清单 | 测试 | 12-15 | 高 |
| 增加监控告警 | 开发 | 12-18 | 中 |

## 6. 流程改进

**新增流程**:
1. 发布前必须进行升级测试
2. 首次发布 10% 灰度，观察 24 小时
3. 监控关键指标（启动成功率、崩溃率）

**更新文档**:
- [ ] 更新 TESTING_CHECKLIST.md
- [ ] 创建 5-03-gradual-release.md
- [ ] 更新 bug_prevention_guide.md

## 7. 经验总结

- 教训: 升级场景是重要测试点，不能忽略
- 改进: 建立灰度发布，降低风险
- 目标: 未来避免全量发布失败

**会议结论**: 
修复计划已明确，预防措施已制定，预计 12-11 重新发布。
```

**保存位置**: `docs/postmortem/rollback-2025-12-06.md`

---

## 💾 数据兼容性处理

### 版本回退导致的数据问题

**场景**: 新版本 v2.0 改了数据结构，现在回退到 v1.9

**问题**: v1.9 无法识别 v2.0 的数据格式

**解决方案：数据降级**:
```javascript
// utils/dataDowngrade.js
export function downgradeData() {
  const version = uni.getStorageSync('app_version');
  
  if (version === '2.0') {
    // 将 v2.0 数据转换为 v1.9 格式
    const v2Data = uni.getStorageSync('user_data_v2');
    const v1Data = convertV2ToV1(v2Data);
    uni.setStorageSync('user_data', v1Data);
  }
}

function convertV2ToV1(v2Data) {
  // 转换逻辑
  return {
    name: v2Data.profile.name, // v2的嵌套结构
    age: v2Data.profile.age,
    // v2新增的字段丢弃
  };
}
```

**启动时检查**:
```javascript
// App.vue - onLaunch
onLaunch(() => {
  downgradeData();
});
```

---

## 🔄 回滚后的恢复计划

### Step 1: 修复原

Bug

**分析失败原因**:
- 为什么没在测试时发现？
- 哪个环节出了问题？

**修复流程**:
```
1. 在本地分支修复 Bug
2. 充分测试（包括之前遗漏的场景）
3. 代码审查
4. 小范围灰度测试
5. 正式发布
```

---

### Step 2: 更新 BUG.md

```markdown
## [已回滚] 严重Bug - 问题描述

**发生时间**: 2025-12-06
**影响版本**: v2.0.0
**回滚版本**: v1.9.5

**问题描述**: [详细描述]

**回滚决策**: 
- 影响范围: 100% 用户
- 严重程度: 应用无法启动
- 决策: 立即回滚

**修复计划**: 
1. 修复 Bug
2. 增加测试用例
3. 重新发布
```

---

### Step 3: 事后分析

**召开复盘会议**:
- 问题根源
- 为什么测试没发现
- 流程改进建议

**更新流程**:
- 加强测试覆盖
- 增加审查环节
- 建立灰度发布机制

---

## 🛡️ 预防措施

### 1. 灰度发布

**逐步放量**:
```
Day 1: 5% 用户
Day 2: 20% 用户（无问题）
Day 3: 50% 用户
Day 4: 100% 用户
```

### 2. 金丝雀发布

**保留旧版本**:
- 50% 用户使用新版本
- 50% 用户继续使用旧版本
- 监控对比数据
- 确认无问题后全量发布

### 3. 回滚演练

**定期演练**:
- 每季度进行一次回滚演练
- 确保所有人熟悉流程
- 验证回滚机制可用

---

## ⚡ 快速回滚命令

**一键回滚脚本**:
```bash
# rollback.sh
#!/bin/bash

# 1. 回退代码
git reset --hard $1  # $1 = 稳定版本hash

# 2. 重新编译
npm run build

# 3. 自动测试
npm run test

echo "回滚完成，请进行人工验证"
```

**使用**:
```bash
./rollback.sh abc1234
```

---

## 📖 参考文档

- [Git 官方文档 - 撤销](https://git-scm.com/book/zh/v2)
- [5-01-git-commit.md](./5-01-git-commit.md) - Git 提交规范

---

**创建时间**: 2025-12-06  
**重要性**: 🔴 关键（建议打印并张贴）
