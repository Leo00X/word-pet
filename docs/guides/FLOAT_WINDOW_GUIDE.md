# 🎮 悬浮窗智能互动系统 - 用户指南

> **版本**: Phase 1-3 完成版  
> **更新日期**: 2025-12-06  
> **状态**: ✅ 功能完整，等待真机测试

---

## 🌟 功能概览

悬浮窗智能互动系统让你的桌面宠物"活"了起来！宠物不再只是静态图片，而是会：

- 🎯 **识别你的手势** - 单击、长按、甩动都有不同反应
- 😴 **自主睡眠** - 深夜自动入睡，早晨醒来跟你问好
- 🧠 **带记忆对话** - 记住你的名字、偏好，越聊越懂你
- 📊 **状态感知** - 根据心情、时间、互动历史智能响应
- 🌐 **离线可用** - 即使没网络，也有丰富的本地响应

---

## 📋 核心功能介绍

### 1️⃣ 手势识别

宠物能识别以下手势：

| 手势 | 操作 | 宠物反应 |
|------|------|----------|
| **单击 (TAP)** | 轻触宠物 | 随机打招呼："嘿~" / "干嘛？" |
| **双击 (DOUBLE_TAP)** | 快速点击2次 | 打开主菜单 |
| **长按 (LONG_PRESS)** | 按住1秒+ | 撒娇："别按太久啦~" / "痒痒的！" |
| **滑动 (SWIPE)** | 快速滑动 | 躲闪："嘿！" / "好快！⚡" |
| **甩动 (THROW)** | 大力甩动 | 抗议："呜哇！" / "别甩我！" |

**进阶手势**：
- **三连击** - 连续3次单击触发特殊对话
- **摇晃** - 手机晃动触发惊吓反应

---

### 2️⃣ 睡眠系统

宠物会在以下情况**自动入睡**：

- 🌙 **深夜时段** (23:00 - 06:00)
- ⏰ **长时间无互动** (超过30分钟)
- 💤 **手动让它睡觉**

**睡眠中的宠物**：
- 每5分钟做一个随机梦（梦到彩虹、美食、主人学习...）
- 每分钟恢复1点心情（最多恢复30点）
- 可以被互动唤醒（但要睡够10分钟才行）

**唤醒条件**：
- ☀️ 早晨时段 + 睡眠超过1小时
- 😴 睡眠超过8小时（强制唤醒）
- 👆 用户主动触摸

---

### 3️⃣ 智能对话

宠物的对话会根据以下因素变化：

#### 📊 状态感知
- **心情 >80**: 开心活泼，用"嘿嘿~"、"好耶！"
- **心情 40-80**: 平静正常
- **心情 <40**: 低落，说话简短："..." / "哼"
- **心情 <20**: 愤怒，进入"红色暴怒"模式

#### 🕐 时间感知
- **早晨 (6-12点)**: "早上好！今天也要加油哦！☀️"
- **下午 (12-18点)**: "要不要午睡一会儿？"
- **晚上 (18-23点)**: "今天学习完成了吗？"
- **深夜 (23-6点)**: "该睡觉了..." / "这么晚还不睡？"

#### 💭 记忆系统
宠物会记住：
- 👤 **你的名字** - 第一次对话时询问
- ❤️ **你的偏好** - 喜欢什么、讨厌什么
- 📅 **重要事件** - 考试、生日、纪念日

---

### 4️⃣ AI 降级策略

为了确保**离线也能玩**，系统有4级响应模式：

| 级别 | 模式 | 说明 | 触发条件 |
|------|------|------|----------|
| **Level 0** | 完整AI | 带记忆和历史，最智能 | 默认 |
| **Level 1** | 压缩AI | 简化Prompt，更快响应 | Level 0 超时 |
| **Level 2** | 本地模板 | 丰富的预设对话库 | 网络错误 |
| **Level 3** | 静态响应 | 基础的4种回复 | 彻底失败 |

**自动恢复**：5分钟没错误后，自动升回高级别

---

## 🎯 使用场景示例

### 场景1：早晨问候
```
[时间] 08:00
[动作] 你点击宠物
[宠物] "早上好！☀️ 今天也要加油哦！"
[动作] 连续对话5句
[宠物] 根据你的回复调整语气和内容
```

### 场景2：学习奖励
```
[状态] 你学习了30分钟
[宠物] 主动弹出："太棒了！继续保持！🎉"
[效果] 心情+10，经验+50
```

### 场景3：摸鱼警告
```
[状态] 你玩游戏超过20分钟
[宠物] 第一次："适当休息一下吧~"
[宠物] 第二次："少玩一会儿..."
[宠物] 第三次："又在摸鱼！💢 去学习！"
[效果] 进入愤怒状态，心情-20
```

### 场景4：睡前互动
```
[时间] 23:30
[动作] 你长按宠物
[宠物] "好困了...要睡觉了..."
[动作] 你再次点击
[宠物] "💤 zzz..."（进入睡眠）
[第二天早晨]
[宠物] 自动唤醒："睡得好香！心情+25"
```

---

## 🛠️ 开发者信息

### 技术架构
```
7个模块化 Composable:
├── useBehaviorTree.js (287行) - 行为树状态管理
├── useGestureRecognizer.js (197行) - 手势识别
├── useInteractionChain.js (204行) - 互动链编排
├── useStateDuration.js (204行) - 状态时长追踪
├── useSleepWake.js (248行) - 睡眠系统
├── useAIContextBuilder.js (219行) - AI上下文构建
├── useAIFallback.js (253行) - 降级策略
└── usePetInteraction.js (300行) - 主协调器
```

所有文件 **<350行**，遵循防臃肿协议 ✓

### 状态定义

**5种根状态**：
- `IDLE` - 待机
- `INTERACTION` - 互动中
- `WORKING` - 工作中（监控学习）
- `ANGRY` - 愤怒
- `SLEEPING` - 睡眠

**12种细分子状态**：
- IDLE: normal, sleepy, anxious, bored, excited, hungry
- SLEEPING: light_sleep, deep_sleep, dreaming
- ANGRY: warning_l1, warning_l2, warning_l3

---

## ❓ 常见问题

### Q1: 宠物不响应手势怎么办？
**A**: 检查悬浮窗权限是否开启，进入"状态监控"查看连接状态。

### Q2: 如何让宠物立即睡觉？
**A**: 目前需要等待自动睡眠触发，或在代码中调用 `triggerSleep()` 方法（开发者模式）。

### Q3: 离线能用吗？
**A**: 可以！Level 2/3 降级模式完全离线，只是对话内容会变简单。

### Q4: 如何重置AI降级状态？
**A**: 调用 `aiController.resetFallback()` 或等待5分钟自动恢复。

### Q5: 哪里可以查看状态统计？
**A**: 调用 `stateDuration.getStatsSummary()` 查看今日统计和平均时长。

---

## 📚 相关文档

- 📖 [技术实现详情](./FLOAT_WINDOW_TECHNICAL.md) - 开发者文档
- 🛡️ [BUG防范指南](./bug_prevention_guide.md) - 代码规范
- 📋 [更新日志](./UPDATES.md) - 版本历史
- 🤖 [AI使用指南](./AI_GUIDE.md) - AI配置

---

## 🎉 下一步计划

- [ ] 真机测试与参数调优
- [ ] 添加更多手势（捏、两指滑动）
- [ ] 完善梦境内容库
- [ ] 添加成就系统联动
- [ ] UI可视化（显示当前状态和降级级别）

---

**制作**: WordParasite Team  
**许可**: MIT License  
**贡献**: 欢迎提交 Issue 和 PR！
