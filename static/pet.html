<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- Lottie Player -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>
    <style>
        /* å…¨å±€é‡ç½® */
        body,
        html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background-color: transparent;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: 'Segoe UI', sans-serif;
            user-select: none;
            -webkit-user-select: none;
            /* [BUG#104] ç©ºç™½åŒºåŸŸä¸æ‹¦æˆªç‚¹å‡»  */
            pointer-events: none;
        }

        /* [BUG#104] å®¹å™¨ - æ”¯æŒåˆ†å±‚å’Œå•ä¸€æ¨¡å¼ */
        .container {
            position: relative;
            width: 120px;
            height: 140px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.1s;
            /* [BUG#104] åªæœ‰å® ç‰©åŒºåŸŸå“åº”ç‚¹å‡» */
            pointer-events: auto;
        }

        .container:active {
            transform: scale(0.95);
        }

        /* ========== åˆ†å±‚å® ç‰©æ¨¡å¼ ========== */
        .pet-parted {
            position: relative;
            width: 100%;
            height: 100%;
            display: none;
            /* é»˜è®¤éšè—ï¼Œåˆ‡æ¢æ—¶æ˜¾ç¤º */
        }

        .pet-parted.active {
            display: block;
        }

        /* éƒ¨ä½é€šç”¨æ ·å¼ */
        .pet-part {
            position: absolute;
            cursor: pointer;
            transition: transform 0.2s ease, filter 0.2s ease;
            pointer-events: auto;
        }

        .pet-part:hover {
            filter: brightness(1.1);
        }

        .pet-part:active {
            transform: scale(0.9);
        }

        .pet-part.touched {
            filter: drop-shadow(0 0 15px rgba(255, 102, 204, 0.8));
        }

        /* å¤´éƒ¨ */
        .pet-part.head {
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 50px;
            z-index: 30;
        }

        /* èº«ä½“ */
        .pet-part.body {
            top: 40px;
            left: 50%;
            transform: translateX(-50%);
            width: 50px;
            height: 50px;
            z-index: 20;
        }

        /* å·¦æ‰‹ */
        .pet-part.left-arm {
            top: 45px;
            left: 5px;
            width: 25px;
            height: 30px;
            z-index: 25;
        }

        /* å³æ‰‹ */
        .pet-part.right-arm {
            top: 45px;
            right: 5px;
            width: 25px;
            height: 30px;
            z-index: 25;
        }

        /* å·¦è„š */
        .pet-part.left-leg {
            top: 85px;
            left: 25px;
            width: 25px;
            height: 30px;
            z-index: 15;
        }

        /* å³è„š */
        .pet-part.right-leg {
            top: 85px;
            right: 25px;
            width: 25px;
            height: 30px;
            z-index: 15;
        }

        /* éƒ¨ä½å›¾ç‰‡ */
        .pet-part img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        /* éƒ¨ä½ Emoji æ¨¡å¼ (æ— å›¾ç‰‡æ—¶) */
        .pet-part .part-emoji {
            font-size: 20px;
            display: block;
            text-align: center;
            line-height: 1;
        }

        /* ========== éƒ¨ä½åŠ¨ç”» ========== */
        @keyframes headShake {

            0%,
            100% {
                transform: translateX(-50%) rotate(0deg);
            }

            25% {
                transform: translateX(-50%) rotate(-10deg);
            }

            75% {
                transform: translateX(-50%) rotate(10deg);
            }
        }

        @keyframes headNod {

            0%,
            100% {
                transform: translateX(-50%) translateY(0);
            }

            50% {
                transform: translateX(-50%) translateY(5px);
            }
        }

        @keyframes bodyBounce {

            0%,
            100% {
                transform: translateX(-50%) scale(1);
            }

            50% {
                transform: translateX(-50%) scale(1.15);
            }
        }

        @keyframes bodyWiggle {

            0%,
            100% {
                transform: translateX(-50%) rotate(0deg);
            }

            25% {
                transform: translateX(-50%) rotate(-5deg);
            }

            75% {
                transform: translateX(-50%) rotate(5deg);
            }
        }

        @keyframes armWave {

            0%,
            100% {
                transform: rotate(0deg);
            }

            50% {
                transform: rotate(-30deg);
            }
        }

        @keyframes armHighfive {
            0% {
                transform: rotate(0deg);
            }

            50% {
                transform: rotate(-45deg) scale(1.2);
            }

            100% {
                transform: rotate(0deg);
            }
        }

        @keyframes legKick {

            0%,
            100% {
                transform: rotate(0deg);
            }

            50% {
                transform: rotate(20deg);
            }
        }

        @keyframes legStomp {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(5px);
            }
        }

        /* åŠ¨ç”»æ¿€æ´»çŠ¶æ€ */
        .pet-part.head.anim-headShake {
            animation: headShake 0.5s ease;
        }

        .pet-part.head.anim-nod {
            animation: headNod 0.5s ease;
        }

        .pet-part.body.anim-bodyBounce {
            animation: bodyBounce 0.5s ease;
        }

        .pet-part.body.anim-wiggle {
            animation: bodyWiggle 0.5s ease;
        }

        .pet-part.left-arm.anim-wave {
            animation: armWave 0.8s ease;
        }

        .pet-part.right-arm.anim-highfive {
            animation: armHighfive 0.5s ease;
        }

        .pet-part.left-leg.anim-kick {
            animation: legKick 0.5s ease;
        }

        .pet-part.right-leg.anim-stomp {
            animation: legStomp 0.3s ease 2;
        }

        /* [BUG#104] å¯¹è¯æ°”æ³¡æ ·å¼  -  ç»å¯¹å®šä½ï¼Œæ‚¬æµ®åœ¨å® ç‰©ä¸Šæ–¹ */
        .bubble {
            position: absolute;
            bottom: 100%;
            /* æ˜¾ç¤ºåœ¨å® ç‰©ä¸Šæ–¹ */
            left: 50%;
            transform: translateX(-50%) translateY(10px);
            background: var(--bubble-bg, rgba(0, 0, 0, 0.85));
            color: var(--bubble-color, #00e676);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            line-height: 1.4;
            max-width: 140px;
            min-width: 80px;
            text-align: center;
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            pointer-events: none;
            border: 1px solid var(--bubble-border, #333);
            white-space: nowrap;
            z-index: 100;
        }

        .bubble.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        .bubble::after {
            content: '';
            position: absolute;
            bottom: -6px;
            left: 50%;
            transform: translateX(-50%);
            border-width: 6px 6px 0;
            border-style: solid;
            border-color: var(--bubble-bg, rgba(0, 0, 0, 0.85)) transparent transparent transparent;
        }

        /* æ°”æ³¡æ ·å¼å˜ä½“ */
        .bubble.cyberpunk {
            background: linear-gradient(135deg, rgba(0, 217, 255, 0.9), rgba(255, 0, 255, 0.9));
            color: #fff;
            border: 1px solid #00ffff;
            text-shadow: 0 0 5px #00ffff;
        }

        .bubble.success {
            background: rgba(46, 213, 115, 0.9);
            color: #fff;
            border-color: #2ed573;
        }

        .bubble.warning {
            background: rgba(255, 71, 87, 0.9);
            color: #fff;
            border-color: #ff4757;
        }

        /* --- å® ç‰©åŒºåŸŸ --- */
        .pet-area {
            width: 100px;
            height: 100px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Lottie åŠ¨ç”»å®¹å™¨ */
        #lottie-container {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
        }

        /* Emoji å® ç‰©ï¼ˆCSSåŠ¨ç”»æ¨¡å¼ï¼‰ */
        .pet-emoji {
            font-size: 70px;
            line-height: 1;
            z-index: 10;
            filter: drop-shadow(0 0 15px var(--glow-color, rgba(0, 217, 255, 0.4)));
            transition: all 0.3s ease;
        }

        /* --- CSS åŠ¨ç”»ç±» --- */
        .anim-idle {
            animation: float 3s ease-in-out infinite;
        }

        .anim-happy {
            animation: bounce 0.5s ease infinite;
        }

        .anim-angry {
            animation: shake 0.3s ease infinite;
            filter: drop-shadow(0 0 20px rgba(255, 68, 68, 0.8)) !important;
        }

        .anim-study {
            animation: pulse 2s ease-in-out infinite;
            filter: drop-shadow(0 0 20px rgba(46, 213, 115, 0.6)) !important;
        }

        .anim-interact {
            animation: heartbeat 0.6s ease;
            filter: drop-shadow(0 0 25px rgba(255, 102, 204, 0.8)) !important;
        }

        /* --- å…³é”®å¸§åŠ¨ç”» --- */
        @keyframes float {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-12px);
            }
        }

        @keyframes bounce {

            0%,
            100% {
                transform: translateY(0) scale(1);
            }

            50% {
                transform: translateY(-15px) scale(1.1);
            }
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0) rotate(0deg);
            }

            25% {
                transform: translateX(-5px) rotate(-5deg);
            }

            75% {
                transform: translateX(5px) rotate(5deg);
            }
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
                opacity: 1;
            }

            50% {
                transform: scale(1.05);
                opacity: 0.9;
            }
        }

        @keyframes heartbeat {
            0% {
                transform: scale(1);
            }

            25% {
                transform: scale(1.2);
            }

            50% {
                transform: scale(1);
            }

            75% {
                transform: scale(1.15);
            }

            100% {
                transform: scale(1);
            }
        }

        /* --- å¹½çµçº¯CSSæ¨¡å¼ï¼ˆå¤‡ç”¨ï¼‰--- */
        .ghost-css {
            width: 80px;
            height: 90px;
            background: var(--pet-color, #fff);
            border-radius: 40px 40px 0 0;
            position: relative;
            box-shadow: 0 0 15px var(--glow-color, rgba(255, 255, 255, 0.4));
        }

        .ghost-css.angry {
            background: #ff4444;
            box-shadow: 0 0 20px rgba(255, 68, 68, 0.6);
        }

        .ghost-footer {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 15px;
            display: flex;
        }

        .wave {
            flex: 1;
            background: inherit;
            border-radius: 0 0 10px 10px;
            margin: 0 -1px;
        }

        .eyes {
            position: absolute;
            top: 35px;
            width: 100%;
            display: flex;
            justify-content: center;
            gap: 12px;
        }

        .eye {
            width: 12px;
            height: 12px;
            background: #2c3e50;
            border-radius: 50%;
            transition: all 0.2s;
        }

        .blush {
            position: absolute;
            top: 50px;
            width: 10px;
            height: 6px;
            background: #ffaaab;
            border-radius: 50%;
            opacity: 0.6;
        }

        .blush.left {
            left: 12px;
        }

        .blush.right {
            right: 12px;
        }

        .mouth {
            position: absolute;
            top: 55px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-radius: 50%;
            background: #2c3e50;
            transition: all 0.2s;
        }

        /* æ„¤æ€’çœ¼ç› */
        .ghost-css.angry .eye {
            height: 4px;
            transform: rotate(20deg);
        }

        .ghost-css.angry .eye:last-child {
            transform: rotate(-20deg);
        }

        .ghost-css.angry .mouth {
            width: 20px;
            height: 10px;
            border-radius: 10px 10px 0 0;
            background: transparent;
            border-top: 3px solid #000;
        }
    </style>
</head>

<body>

    <div class="container" id="petArea">
        <!-- å¯¹è¯æ°”æ³¡ -->
        <div class="bubble" id="bubble">WordParasite<br>å·²å¯„ç”Ÿ...</div>

        <!-- å® ç‰©åŒºåŸŸ -->
        <div class="pet-area">
            <!-- Lottie åŠ¨ç”»å®¹å™¨ -->
            <div id="lottie-container"></div>

            <!-- Emoji æ¨¡å¼ (å•ä¸€æ¨¡å¼) -->
            <span class="pet-emoji anim-idle" id="petEmoji">ğŸ‘»</span>

            <!-- åˆ†å±‚å® ç‰©æ¨¡å¼ (6éƒ¨ä½) -->
            <div class="pet-parted" id="petParted">
                <div class="pet-part head" data-part="head">
                    <span class="part-emoji">ğŸ‘»</span>
                </div>
                <div class="pet-part body" data-part="body">
                    <span class="part-emoji">ğŸ«¥</span>
                </div>
                <div class="pet-part left-arm" data-part="left-arm">
                    <span class="part-emoji">ğŸ¤š</span>
                </div>
                <div class="pet-part right-arm" data-part="right-arm">
                    <span class="part-emoji">âœ‹</span>
                </div>
                <div class="pet-part left-leg" data-part="left-leg">
                    <span class="part-emoji">ğŸ¦µ</span>
                </div>
                <div class="pet-part right-leg" data-part="right-leg">
                    <span class="part-emoji">ğŸ¦¶</span>
                </div>
            </div>

            <!-- CSS Ghost æ¨¡å¼ï¼ˆå¤‡ç”¨ï¼‰ -->
            <!-- <div class="ghost-css anim-idle" id="ghostCss">
                <div class="eyes">
                    <div class="eye left"></div>
                    <div class="eye right"></div>
                </div>
                <div class="blush left"></div>
                <div class="blush right"></div>
                <div class="mouth"></div>
                <div class="ghost-footer">
                    <div class="wave"></div>
                    <div class="wave"></div>
                    <div class="wave"></div>
                    <div class="wave"></div>
                </div>
            </div> -->
        </div>
    </div>


    <script>
        // ========== å…ƒç´ å¼•ç”¨ ==========
        const petArea = document.getElementById('petArea');
        const bubble = document.getElementById('bubble');
        const petEmoji = document.getElementById('petEmoji');
        const lottieContainer = document.getElementById('lottie-container');
        const petParted = document.getElementById('petParted');
        const petParts = document.querySelectorAll('.pet-part');

        // ========== çŠ¶æ€ç®¡ç† ==========
        let bubbleTimer = null;
        let currentState = 'idle';
        let currentSkin = null;
        let lottieAnimations = {}; // ç¼“å­˜çš„ Lottie åŠ¨ç”»å®ä¾‹
        let currentLottie = null;
        let renderMode = 'emoji'; // 'emoji' | 'lottie' | 'css' | 'parted'
        let partedMode = false;   // æ˜¯å¦å¯ç”¨åˆ†å±‚æ¨¡å¼

        // ========== æ¶ˆæ¯å¤„ç† ==========

        /**
         * æ¥æ”¶ uni-app æ¶ˆæ¯
         * @param {number} type - æ¶ˆæ¯ç±»å‹
         * @param {string} msg - æ¶ˆæ¯å†…å®¹
         */
        window.dataFromUniapp = function (type, msg) {
            console.log("[Pet] æ”¶åˆ°æ¶ˆæ¯:", type, msg);

            try {
                // å°è¯•è§£æ JSON
                let data = msg;
                if (typeof msg === 'string' && (msg.startsWith('{') || msg.startsWith('['))) {
                    data = JSON.parse(msg);
                }

                switch (type) {
                    case 0: // éšè—æ°”æ³¡
                        hideBubble();
                        break;

                    case 1: // æ™®é€šæ¶ˆæ¯ + æ­£å¸¸çŠ¶æ€
                        showBubble(typeof data === 'string' ? data : data.message);
                        changeState('idle');
                        break;

                    case 2: // æ„¤æ€’æ¶ˆæ¯
                        showBubble(typeof data === 'string' ? data : data.message);
                        changeState('angry');
                        break;

                    case 3: // æ¢å¤æ­£å¸¸
                        changeState('idle');
                        break;

                    case 98: // åŠ¨ç”»çŠ¶æ€åˆ‡æ¢
                        handleStateChange(data);
                        break;

                    case 99: // çš®è‚¤åˆ‡æ¢
                        handleSkinChange(data);
                        break;

                    case 97: // [æ–°] åˆ‡æ¢åˆ°åˆ†å±‚æ¨¡å¼
                        handlePartedModeSwitch(data);
                        break;

                    case 200: // [æ–°] å¤šæ¨¡æ€ AI å“åº”
                        handleMultimodalResponse(data);
                        break;

                    default:
                        console.log("[Pet] æœªçŸ¥æ¶ˆæ¯ç±»å‹:", type);
                }
            } catch (err) {
                console.error("[Pet] æ¶ˆæ¯å¤„ç†é”™è¯¯:", err);
            }
        };

        /**
         * å¤„ç†åŠ¨ç”»çŠ¶æ€åˆ‡æ¢
         * @param {Object} data - { action, state, duration, shake, emoji, part, animation }
         */
        function handleStateChange(data) {
            // éƒ¨ä½åŠ¨ç”» (åˆ†å±‚æ¨¡å¼)
            if (data.action === 'part_animation' && data.part) {
                playPartAnimation(data.part, data.animation, data.duration || 800);
                return;
            }

            if (data.action !== 'change_state') return;

            const { state, duration, shake, emoji } = data;
            changeState(state, duration);

            // å¦‚æœæœ‰ä¸´æ—¶ emoji è¦†ç›–
            if (emoji && renderMode === 'emoji') {
                const originalEmoji = petEmoji.textContent;
                petEmoji.textContent = emoji;

                if (duration > 0) {
                    setTimeout(() => {
                        petEmoji.textContent = originalEmoji;
                    }, duration);
                }
            }
        }

        /**
         * åˆ‡æ¢åˆ°åˆ†å±‚æ¨¡å¼
         * @param {Object} data - { action, enabled, parts }
         */
        function handlePartedModeSwitch(data) {
            if (data.action !== 'parted_mode') return;

            partedMode = data.enabled !== false;
            console.log('[Pet] åˆ†å±‚æ¨¡å¼:', partedMode ? 'å¼€å¯' : 'å…³é—­');

            if (partedMode) {
                switchToPartedMode(data.parts);
            } else {
                switchToEmojiMode();
            }
        }

        /**
         * æ’­æ”¾éƒ¨ä½åŠ¨ç”»
         * @param {string} partName - éƒ¨ä½åç§°
         * @param {string} animation - åŠ¨ç”»åç§°
         * @param {number} duration - æŒç»­æ—¶é—´
         */
        function playPartAnimation(partName, animation, duration = 800) {
            const part = document.querySelector(`.pet-part.${partName}`);
            if (!part) {
                console.log('[Pet] æ‰¾ä¸åˆ°éƒ¨ä½:', partName);
                return;
            }

            console.log('[Pet] æ’­æ”¾éƒ¨ä½åŠ¨ç”»:', partName, animation);

            // æ·»åŠ è§¦æ‘¸åé¦ˆ
            part.classList.add('touched');

            // æ·»åŠ åŠ¨ç”»ç±»
            if (animation) {
                part.classList.add('anim-' + animation);
            }

            // ç§»é™¤æ•ˆæœ
            setTimeout(() => {
                part.classList.remove('touched');
                if (animation) {
                    part.classList.remove('anim-' + animation);
                }
            }, duration);
        }

        /**
         * åˆ‡æ¢åˆ°åˆ†å±‚æ¨¡å¼
         * @param {Object} parts - éƒ¨ä½é…ç½® { head: {emoji, img}, ... }
         */
        function switchToPartedMode(parts) {
            if (renderMode === 'parted' && partedMode) {
                // å·²ç»æ˜¯åˆ†å±‚æ¨¡å¼ï¼Œä»…æ›´æ–°éƒ¨ä½
                updateParts(parts);
                return;
            }

            renderMode = 'parted';
            partedMode = true;

            // éšè—å…¶ä»–æ¨¡å¼
            petEmoji.style.display = 'none';
            lottieContainer.style.display = 'none';

            // æ˜¾ç¤ºåˆ†å±‚å®¹å™¨
            petParted.classList.add('active');

            // åº”ç”¨éƒ¨ä½é…ç½®
            updateParts(parts);

            console.log('[Pet] å·²åˆ‡æ¢åˆ°åˆ†å±‚æ¨¡å¼');
        }

        /**
         * æ›´æ–°éƒ¨ä½æ˜¾ç¤º
         */
        function updateParts(parts) {
            if (!parts) return;

            Object.keys(parts).forEach(partName => {
                const partEl = document.querySelector(`.pet-part.${partName}`);
                if (!partEl) return;

                const config = parts[partName];

                // é‡ç½®æ ·å¼
                partEl.style.backgroundImage = '';
                partEl.style.backgroundPosition = '';
                partEl.style.backgroundSize = '';
                partEl.style.backgroundRepeat = '';
                partEl.style.display = ''; // Reset display for emoji mode
                partEl.style.alignItems = '';
                partEl.style.justifyContent = '';
                partEl.style.fontSize = '';
                partEl.textContent = ''; // æ¸…ç©ºå†…å®¹

                // 1. Sprite æ¨¡å¼
                if (config.type === 'sprite' && config.src) {
                    partEl.style.backgroundImage = `url(${config.src})`;
                    partEl.style.backgroundPosition = config.bgPos || '0 0';
                    partEl.style.backgroundSize = config.bgSize || 'cover';
                    partEl.style.backgroundRepeat = 'no-repeat';
                }
                // 2. ç‹¬ç«‹å›¾ç‰‡æ¨¡å¼
                else if (config.img) {
                    const img = document.createElement('img');
                    img.src = config.img;
                    img.style.width = '100%';
                    img.style.height = '100%';
                    img.style.objectFit = 'contain';
                    // ç¦æ­¢å›¾ç‰‡å“åº”ç‚¹å‡»ï¼Œè®©çˆ¶çº§divå“åº”
                    img.style.pointerEvents = 'none';
                    partEl.appendChild(img);
                }
                // 3. Emoji æ¨¡å¼
                else if (config.emoji) {
                    partEl.textContent = config.emoji;
                    partEl.style.display = 'flex';
                    partEl.style.alignItems = 'center';
                    partEl.style.justifyContent = 'center';
                    partEl.style.fontSize = '32px';
                }
            });
        }

        /**
         * å¤„ç†çš®è‚¤åˆ‡æ¢
         * @param {Object} data - { action, skinId, petType, animations, styles }
         */
        function handleSkinChange(data) {
            if (data.action !== 'change_skin') return;

            currentSkin = data;
            console.log("[Pet] åˆ‡æ¢çš®è‚¤:", data.skinId);

            // åº”ç”¨æ ·å¼
            applyStyles(data.styles);

            // åˆ‡æ¢æ¸²æŸ“æ¨¡å¼
            if (data.type === 'parted' || (data.parts && Object.keys(data.parts).length > 0)) {
                // [æ–°] åˆ†å±‚æ¨¡å¼ (Sprite / ç‹¬ç«‹å›¾ç‰‡)
                switchToPartedMode(data.parts);
            } else if (data.animations && Object.keys(data.animations).some(k =>
                data.animations[k].endsWith('.json'))
            ) {
                // Lottie æ¨¡å¼
                switchToLottieMode(data.animations);
            } else {
                // Emoji/CSS æ¨¡å¼
                switchToEmojiMode(data.petType);
            }
        }

        /**
         * [æ–°] å¤„ç†å¤šæ¨¡æ€ AI å“åº”
         * @param {Object} data - { action, text, bubbleColor, duration, emotion }
         */
        function handleMultimodalResponse(data) {
            console.log("[Pet] å¤šæ¨¡æ€å“åº”:", data);

            const { action, text, bubbleColor, duration, emotion } = data;

            // 1. æ’­æ”¾åŠ¨ç”»
            if (action && action !== 'idle') {
                // æ˜ å°„ AI åŠ¨ä½œåˆ°ç°æœ‰åŠ¨ç”»çŠ¶æ€
                const actionMap = {
                    'jump': 'happy',
                    'wave': 'happy',
                    'celebrate': 'happy',
                    'shake': 'angry',
                    'hide': 'idle',
                    'spin': 'happy',
                    'nod': 'idle',
                    'sleep': 'idle',
                    'scared': 'angry',
                    'shy': 'interact'
                };
                const animState = actionMap[action] || 'idle';
                changeState(animState, duration || 1500);
            }

            // 2. æ˜¾ç¤ºæ°”æ³¡
            if (text) {
                // åŠ¨æ€è®¾ç½®æ°”æ³¡é¢œè‰²
                if (bubbleColor) {
                    document.documentElement.style.setProperty('--bubble-bg', bubbleColor);
                }

                // æ ¹æ®æƒ…æ„Ÿé€‰æ‹©æ°”æ³¡æ ·å¼
                let bubbleStyle = 'default';
                if (emotion === 'happy' || emotion === 'excited') {
                    bubbleStyle = 'success';
                } else if (emotion === 'angry') {
                    bubbleStyle = 'warning';
                }

                showBubble(text, bubbleStyle);
            }

            // 3. è§¦è§‰åé¦ˆï¼ˆå¦‚æœæ”¯æŒï¼‰
            if (navigator.vibrate && (action === 'shake' || action === 'jump')) {
                navigator.vibrate(50);
            }
        }

        // ========== æ¸²æŸ“æ¨¡å¼åˆ‡æ¢ ==========

        /**
         * åˆ‡æ¢åˆ° Lottie åŠ¨ç”»æ¨¡å¼
         * @param {Object} animations - { idle: 'path.json', happy: 'path.json', ... }
         */
        function switchToLottieMode(animations) {
            renderMode = 'lottie';
            petEmoji.style.display = 'none';
            lottieContainer.style.display = 'block';

            // é¢„åŠ è½½æ‰€æœ‰åŠ¨ç”»
            Object.keys(animations).forEach(state => {
                if (animations[state].endsWith('.json')) {
                    loadLottieAnimation(state, animations[state]);
                }
            });

            // æ’­æ”¾ idle
            playLottieAnimation('idle');
        }

        /**
         * åˆ‡æ¢åˆ° Emoji æ¨¡å¼
         * @param {string} petType - å® ç‰©ç±»å‹
         */
        function switchToEmojiMode(petType) {
            renderMode = 'emoji';
            petEmoji.style.display = 'block';
            lottieContainer.style.display = 'none';

            // æ ¹æ®ç±»å‹è®¾ç½® emoji
            const emojiMap = {
                'ghost': 'ğŸ‘»',
                'dog': 'ğŸ•',
                'cockatiel': 'ğŸ¦œ',
                'monk_parakeet': 'ğŸ¦œ'
            };
            petEmoji.textContent = emojiMap[petType] || 'ğŸ‘»';
        }

        /**
         * åŠ è½½ Lottie åŠ¨ç”»
         * @param {string} name - åŠ¨ç”»åç§°
         * @param {string} path - åŠ¨ç”» JSON è·¯å¾„
         */
        function loadLottieAnimation(name, path) {
            if (lottieAnimations[name]) return; // å·²åŠ è½½

            try {
                lottieAnimations[name] = lottie.loadAnimation({
                    container: lottieContainer,
                    renderer: 'svg',
                    loop: name === 'idle' || name === 'study',
                    autoplay: false,
                    path: path,
                    name: name
                });
                console.log("[Pet] Lottie åŠ è½½:", name);
            } catch (err) {
                console.error("[Pet] Lottie åŠ è½½å¤±è´¥:", name, err);
            }
        }

        /**
         * æ’­æ”¾ Lottie åŠ¨ç”»
         * @param {string} name - åŠ¨ç”»åç§°
         */
        function playLottieAnimation(name) {
            if (currentLottie) {
                currentLottie.stop();
            }

            if (lottieAnimations[name]) {
                currentLottie = lottieAnimations[name];
                currentLottie.goToAndPlay(0);
            }
        }

        // ========== çŠ¶æ€ä¸æ ·å¼ ==========

        /**
         * æ”¹å˜åŠ¨ç”»çŠ¶æ€
         * @param {string} state - çŠ¶æ€å
         * @param {number} duration - æŒç»­æ—¶é—´ï¼ˆ0è¡¨ç¤ºæ°¸ä¹…ï¼‰
         */
        function changeState(state, duration = 0) {
            currentState = state;

            if (renderMode === 'lottie' && lottieAnimations[state]) {
                playLottieAnimation(state);
            } else {
                // CSS åŠ¨ç”»æ¨¡å¼
                petEmoji.className = 'pet-emoji anim-' + state;
            }

            // è‡ªåŠ¨æ¢å¤
            if (duration > 0 && state !== 'idle') {
                setTimeout(() => {
                    changeState('idle');
                }, duration);
            }
        }

        /**
         * åº”ç”¨çš®è‚¤æ ·å¼
         * @param {Object} styles - æ ·å¼é…ç½®
         */
        function applyStyles(styles) {
            if (!styles) return;

            const root = document.documentElement;

            // ä¸»è‰²è°ƒ
            if (styles.primaryColor) {
                root.style.setProperty('--glow-color', styles.primaryColor + '66');
                root.style.setProperty('--pet-color', styles.primaryColor);
            }

            // æ°”æ³¡æ ·å¼
            if (styles.bubble) {
                if (styles.bubble.background) {
                    root.style.setProperty('--bubble-bg', styles.bubble.background);
                }
                if (styles.bubble.textColor) {
                    root.style.setProperty('--bubble-color', styles.bubble.textColor);
                }
                if (styles.bubble.borderColor) {
                    root.style.setProperty('--bubble-border', styles.bubble.borderColor);
                }
            }

            // æ°”æ³¡æ ·å¼ç±»
            if (styles.bubbleStyle && styles.bubbleStyle !== 'default') {
                bubble.classList.add(styles.bubbleStyle);
            }
        }

        // ========== æ°”æ³¡åŠŸèƒ½ ==========

        function showBubble(text, style = 'default') {
            bubble.innerHTML = text;
            bubble.className = 'bubble show';
            if (style !== 'default') {
                bubble.classList.add(style);
            }

            // [ç¦ç”¨] åŠ¨æ€å°ºå¯¸è°ƒæ•´ä¼šå¯¼è‡´ä½ç½®é‡ç½®ï¼Œæš‚æ—¶ç¦ç”¨
            // ç°åœ¨ NORMAL å’Œ BUBBLE å°ºå¯¸ç›¸åŒï¼Œæ— éœ€åˆ‡æ¢
            // if (typeof uniapp !== 'undefined') {
            //     uniapp.sendDataToUni(50, JSON.stringify({
            //         action: 'resize',
            //         size: 'BUBBLE'
            //     }));
            // }

            if (bubbleTimer) clearTimeout(bubbleTimer);
            bubbleTimer = setTimeout(() => {
                hideBubble();
            }, 5000);
        }

        function hideBubble() {
            bubble.classList.remove('show');

            // [ç¦ç”¨] åŠ¨æ€å°ºå¯¸è°ƒæ•´
            // if (typeof uniapp !== 'undefined') {
            //     uniapp.sendDataToUni(50, JSON.stringify({
            //         action: 'resize',
            //         size: 'NORMAL'
            //     }));
            // }
        }

        // ========== æ‹–æ‹½ç³»ç»Ÿ ==========

        let isDragging = false;
        let dragStartX = 0;
        let dragStartY = 0;
        let dragThreshold = 10; // ç§»åŠ¨è¶…è¿‡10pxæ‰ç®—æ‹–æ‹½
        let hasMoved = false;

        // æ‹–æ‹½å¼€å§‹
        function onDragStart(e) {
            // æ³¨æ„: ä¸åœ¨è¿™é‡Œè°ƒç”¨ preventDefault()ï¼Œå¦åˆ™ä¼šé˜»æ­¢ click äº‹ä»¶
            // ç³»ç»Ÿé•¿æŒ‰èœå•ç”± contextmenu äº‹ä»¶ç›‘å¬å™¨å•ç‹¬é˜»æ­¢

            const touch = e.touches ? e.touches[0] : e;
            dragStartX = touch.clientX;
            dragStartY = touch.clientY;
            hasMoved = false;

            // å¯åŠ¨é•¿æŒ‰æ£€æµ‹
            longPressTimer = setTimeout(() => {
                if (!hasMoved) {
                    onLongPress();
                }
            }, 800);
        }

        // æ‹–æ‹½ç§»åŠ¨
        function onDragMove(e) {
            if (!dragStartX && !dragStartY) return;

            const touch = e.touches ? e.touches[0] : e;
            const deltaX = touch.clientX - dragStartX;
            const deltaY = touch.clientY - dragStartY;

            // æ£€æŸ¥æ˜¯å¦è¶…è¿‡é˜ˆå€¼
            if (Math.abs(deltaX) > dragThreshold || Math.abs(deltaY) > dragThreshold) {
                hasMoved = true;
                isDragging = true;

                // å–æ¶ˆé•¿æŒ‰
                if (longPressTimer) {
                    clearTimeout(longPressTimer);
                    longPressTimer = null;
                }

                // å‘é€æ‹–æ‹½äº‹ä»¶ç»™ uni-appï¼ˆè®©åŸç”Ÿå±‚å¤„ç†çª—å£ç§»åŠ¨ï¼‰
                if (typeof uniapp !== 'undefined') {
                    uniapp.sendDataToUni(10, JSON.stringify({
                        event: 'drag_move',
                        deltaX: deltaX,
                        deltaY: deltaY
                    }));
                }
            }
        }

        // æ‹–æ‹½ç»“æŸ
        function onDragEnd(e) {
            // å–æ¶ˆé•¿æŒ‰å®šæ—¶å™¨
            if (longPressTimer) {
                clearTimeout(longPressTimer);
                longPressTimer = null;
            }

            if (isDragging) {
                // æ‹–æ‹½ç»“æŸï¼Œå‘é€å¸é™„è¯·æ±‚
                if (typeof uniapp !== 'undefined') {
                    uniapp.sendDataToUni(11, JSON.stringify({
                        event: 'drag_end',
                        timestamp: Date.now()
                    }));
                }
                isDragging = false;
            }

            dragStartX = 0;
            dragStartY = 0;
        }

        // ========== äº¤äº’äº‹ä»¶ ==========

        let clickCount = 0;
        let clickTimer = null;
        let longPressTimer = null;

        // ç‚¹å‡»å¤„ç†ï¼ˆåŒºåˆ†å•å‡»/åŒå‡»ï¼‰
        petArea.addEventListener('click', function (e) {
            // å¦‚æœåˆšæ‹–æ‹½è¿‡ï¼Œå¿½ç•¥ç‚¹å‡»
            if (hasMoved) {
                hasMoved = false;
                return;
            }

            clickCount++;

            if (clickCount === 1) {
                // ç­‰å¾…çœ‹æ˜¯å¦æœ‰ç¬¬äºŒæ¬¡ç‚¹å‡»
                clickTimer = setTimeout(() => {
                    // å•å‡»
                    onSingleClick();
                    clickCount = 0;
                }, 250);
            } else if (clickCount === 2) {
                // åŒå‡»
                clearTimeout(clickTimer);
                clickCount = 0;
                onDoubleClick();
            }
        });

        // å•å‡»äº‹ä»¶
        function onSingleClick() {
            // é€šçŸ¥ uni-app
            if (typeof uniapp !== 'undefined') {
                uniapp.sendDataToUni(1, JSON.stringify({
                    event: 'pet_clicked',
                    state: currentState,
                    timestamp: Date.now()
                }));
            }

            // æœ¬åœ°åé¦ˆï¼šæ’­æ”¾äº’åŠ¨åŠ¨ç”»
            changeState('interact', 1500);

            // çœ¨çœ¼æ•ˆæœï¼ˆå¦‚æœæ˜¯ CSS æ¨¡å¼ï¼‰
            if (renderMode === 'css') {
                const eyes = document.querySelectorAll('.eye');
                eyes.forEach(e => e.style.height = '2px');
                setTimeout(() => {
                    eyes.forEach(e => e.style.height = '12px');
                }, 200);
            }
        }

        // åŒå‡»äº‹ä»¶ - æ˜¾ç¤ºå¿«æ·èœå•
        function onDoubleClick() {
            if (typeof uniapp !== 'undefined') {
                uniapp.sendDataToUni(4, JSON.stringify({
                    event: 'double_click',
                    timestamp: Date.now()
                }));
            }

            // æ˜¾ç¤º"æ‰“å¼€ä¸»ç•Œé¢"æç¤º
            showBubble('ğŸ’¬ åŒå‡»æ‰“å¼€App', 'success');
        }

        // é•¿æŒ‰äº‹ä»¶
        function onLongPress() {
            // [BUG#102 ä¿®å¤] å‘é€é•¿æŒ‰äº‹ä»¶ç»™ uni-app å¤„ç†ï¼Œç”± AI è¿”å›å“åº”
            if (typeof uniapp !== 'undefined') {
                uniapp.sendDataToUni(3, JSON.stringify({
                    event: 'long_press',
                    type: 'LONGPRESS',  // æ·»åŠ æ ‡å‡†ç±»å‹ä¾›æ‰‹åŠ¿è¯†åˆ«å™¨ä½¿ç”¨
                    duration: 800
                }));
            }

            // æœ¬åœ°åé¦ˆï¼šæ’­æ”¾å®³ç¾åŠ¨ç”»ï¼ˆä¸å†æ˜¾ç¤ºç¡¬ç¼–ç æ–‡æœ¬ï¼Œç­‰å¾… AI å“åº”ï¼‰
            changeState('shy', 1000);
        }

        // [BUG#102 ä¿®å¤] è§¦æ‘¸äº‹ä»¶ç»‘å®š - ç§»é™¤ passive:true ä»¥å…è®¸ preventDefault
        petArea.addEventListener('touchstart', onDragStart, { passive: false });
        petArea.addEventListener('touchmove', onDragMove, { passive: true });
        petArea.addEventListener('touchend', onDragEnd);
        petArea.addEventListener('touchcancel', onDragEnd);

        // [BUG#102 ä¿®å¤] é˜»æ­¢ç³»ç»Ÿå³é”®/é•¿æŒ‰èœå•
        petArea.addEventListener('contextmenu', function (e) {
            e.preventDefault();
            e.stopPropagation();
            return false;
        });

        // é¼ æ ‡äº‹ä»¶ï¼ˆH5è°ƒè¯•ç”¨ï¼‰
        petArea.addEventListener('mousedown', onDragStart);
        document.addEventListener('mousemove', onDragMove);
        document.addEventListener('mouseup', onDragEnd);

        // ========== å¿«æ·æ“ä½œ ==========

        // æ‘‡ä¸€æ‘‡æ£€æµ‹ï¼ˆæ‰‹æœºæ™ƒåŠ¨ï¼‰
        if (window.DeviceMotionEvent) {
            let lastShakeTime = 0;
            const shakeThreshold = 25;  // æé«˜é˜ˆå€¼ï¼Œé¿å…è¯¯è§¦ï¼ˆåŸ15ï¼‰

            window.addEventListener('devicemotion', function (e) {
                const acc = e.accelerationIncludingGravity;
                if (!acc) return;

                const total = Math.abs(acc.x) + Math.abs(acc.y) + Math.abs(acc.z);

                if (total > shakeThreshold) {
                    const now = Date.now();
                    // å»¶é•¿å†·å´æ—¶é—´åˆ°3ç§’ï¼Œé¿å…è¿ç»­è§¦å‘ï¼ˆåŸ1000ï¼‰
                    if (now - lastShakeTime > 3000) {
                        lastShakeTime = now;
                        onShake();
                    }
                }
            });
        }

        function onShake() {
            if (typeof uniapp !== 'undefined') {
                uniapp.sendDataToUni(5, JSON.stringify({
                    event: 'shake',
                    timestamp: Date.now()
                }));
            }

            // æ‘‡æ™ƒåé¦ˆ
            changeState('happy', 2000);
            showBubble('ğŸ‰ æ‘‡ä¸€æ‘‡ï¼');
        }

        // ========== åˆå§‹åŒ– ==========

        console.log('[Pet] æ‚¬æµ®çª—åˆå§‹åŒ–å®Œæˆ');

        // [BUG#1 ä¿®å¤] ç§»é™¤è‡ªåŠ¨æ˜¾ç¤ºçš„åˆå§‹åŒ–æ¶ˆæ¯
        // åˆå§‹æ¶ˆæ¯ç»Ÿä¸€ç”± uni-app ç«¯æ§åˆ¶ï¼ˆhandleTogglePetï¼‰ï¼Œé¿å…ä¸å¾…å‘é€é—®å€™å†²çª
        // å¦‚æœæœ‰å¾…å‘é€é—®å€™åˆ™æ˜¾ç¤ºé—®å€™ï¼Œå¦åˆ™æ˜¾ç¤ºé»˜è®¤åˆå§‹æ¶ˆæ¯

        // ========== éƒ¨ä½ç‚¹å‡»äº‹ä»¶ç»‘å®š ==========
        petParts.forEach(part => {
            part.addEventListener('click', function (e) {
                // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé¿å…è§¦å‘æ•´ä½“ç‚¹å‡»
                e.stopPropagation();

                const partName = this.dataset.part;
                if (!partName) return;

                console.log('[Pet] éƒ¨ä½ç‚¹å‡»:', partName);

                // æœ¬åœ°åé¦ˆï¼šè§¦æ‘¸æ•ˆæœ
                this.classList.add('touched');
                setTimeout(() => {
                    this.classList.remove('touched');
                }, 500);

                // å‘é€éƒ¨ä½ç‚¹å‡»äº‹ä»¶ç»™ uni-app
                if (typeof uniapp !== 'undefined') {
                    uniapp.sendDataToUni(100, JSON.stringify({
                        gesture: 'PART_TAP',
                        event: 'part_clicked',
                        part: partName,
                        timestamp: Date.now()
                    }));
                }
            });

            // é•¿æŒ‰éƒ¨ä½
            let partLongPressTimer = null;
            part.addEventListener('touchstart', function (e) {
                const partName = this.dataset.part;
                partLongPressTimer = setTimeout(() => {
                    console.log('[Pet] éƒ¨ä½é•¿æŒ‰:', partName);
                    if (typeof uniapp !== 'undefined') {
                        uniapp.sendDataToUni(100, JSON.stringify({
                            gesture: 'PART_LONG_PRESS',
                            event: 'part_long_pressed',
                            part: partName,
                            timestamp: Date.now()
                        }));
                    }
                }, 800);
            }, { passive: true });

            part.addEventListener('touchend', function (e) {
                if (partLongPressTimer) {
                    clearTimeout(partLongPressTimer);
                    partLongPressTimer = null;
                }
            });

            part.addEventListener('touchcancel', function (e) {
                if (partLongPressTimer) {
                    clearTimeout(partLongPressTimer);
                    partLongPressTimer = null;
                }
            });
        });

        console.log('[Pet] éƒ¨ä½ç‚¹å‡»äº‹ä»¶å·²ç»‘å®šï¼Œå…±', petParts.length, 'ä¸ªéƒ¨ä½');

    </script>
</body>

</html>