<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pet Live2D</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body,
        html {
            width: 100%;
            height: 100%;
            background: transparent;
            overflow: hidden;
            font-family: sans-serif;
            user-select: none;
        }

        #live2d-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .bubble {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%) translateY(10px);
            background: rgba(0, 0, 0, 0.85);
            color: #00e676;
            padding: 8px 14px;
            border-radius: 10px;
            font-size: 13px;
            max-width: 160px;
            text-align: center;
            opacity: 0;
            transition: all 0.3s;
            z-index: 100;
        }

        .bubble.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #00e676;
            font-size: 12px;
            text-align: center;
        }

        #loading.hidden {
            display: none;
        }

        .spinner {
            width: 30px;
            height: 30px;
            border: 3px solid rgba(0, 230, 118, 0.3);
            border-top-color: #00e676;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <div class="bubble" id="bubble">Loading...</div>
    <div id="loading">
        <div class="spinner"></div>
        <div id="loading-text">等待模型数据...</div>
    </div>
    <div id="live2d-container"></div>

    <script src="./lib/live2dcubismcore.min.js"></script>
    <script src="./lib/live2d.min.js"></script>
    <script src="./lib/pixi.min.js"></script>
    <script src="./lib/cubism2.min.js"></script>
    <script src="./lib/cubism4.min.js"></script>

    <script>
        let app = null, model = null, bubbleTimer = null;

        function initApp() {
            if (app) return;
            app = new PIXI.Application({
                view: document.createElement('canvas'),
                resizeTo: window,
                backgroundAlpha: 0,
                antialias: true
            });
            document.getElementById('live2d-container').appendChild(app.view);
            console.log('[Live2D] PIXI 应用已创建');
        }

        // Base64 Data URL 转 Blob
        function dataURLToBlob(dataURL) {
            const parts = dataURL.split(',');
            const mime = parts[0].match(/:(.*?);/)[1];
            const binary = atob(parts[1]);
            const array = new Uint8Array(binary.length);
            for (let i = 0; i < binary.length; i++) {
                array[i] = binary.charCodeAt(i);
            }
            return new Blob([array], { type: mime });
        }

        // 从文件数据加载模型 - 使用 Object URL 方案
        async function loadModelFromFiles(filesData, modelName) {
            console.log('[Live2D] 开始加载模型, 共', filesData.length, '个文件');
            setLoadingText('正在处理文件...');

            try {
                // 1. 为每个文件创建 Object URL 和路径映射
                const urlMap = {};
                let settingsJSON = null;
                let settingsPath = null;

                for (const f of filesData) {
                    const blob = dataURLToBlob(f.data);
                    const objectURL = URL.createObjectURL(blob);
                    urlMap[f.path] = objectURL;
                    console.log(`[Live2D] URL映射: ${f.path} -> ${objectURL.substring(0, 30)}...`);

                    // 找到 settings 文件
                    if (f.path.endsWith('.model.json') || f.path.endsWith('.model3.json')) {
                        settingsPath = f.path;
                        // 解析 settings JSON
                        const text = atob(f.data.split(',')[1]);
                        settingsJSON = JSON.parse(text);
                        console.log('[Live2D] 找到 settings 文件:', f.path);
                    }
                }

                if (!settingsJSON) {
                    throw new Error('未找到 model.json 或 model3.json 文件');
                }

                setLoadingText('正在加载模型...');

                // 2. 设置 url 属性 (虚拟路径，用于解析相对路径)
                settingsJSON.url = settingsPath;

                // 3. 创建自定义 URL 解析器
                const customResolver = (settingsURL, path) => {
                    // 获取基础目录
                    const baseDir = settingsURL.substring(0, settingsURL.lastIndexOf('/') + 1);
                    const fullPath = baseDir + path;
                    const resolved = urlMap[fullPath] || urlMap[path];
                    console.log(`[Live2D] resolveURL: ${path} -> ${resolved ? 'found' : 'NOT FOUND'}`);
                    return resolved || path;
                };

                // 4. 使用 Live2DModel 加载
                if (!PIXI?.live2d?.Live2DModel) {
                    throw new Error('Live2DModel 未定义');
                }

                // 创建模型设置并覆盖 resolveURL
                const ModelSettingsClass = settingsPath.endsWith('.model3.json')
                    ? PIXI.live2d.Cubism4ModelSettings
                    : PIXI.live2d.Cubism2ModelSettings;

                const settings = new ModelSettingsClass(settingsJSON);

                // 覆盖 URL 解析方法
                const originalResolve = settings.resolveURL.bind(settings);
                settings.resolveURL = (path) => {
                    const resolved = urlMap[path] || customResolver(settingsPath, path);
                    return resolved;
                };

                console.log('[Live2D] 开始创建模型...');
                model = await PIXI.live2d.Live2DModel.from(settings, {
                    autoInteract: false
                });

                setupModel(model);
                app.stage.addChild(model);
                document.getElementById('loading').classList.add('hidden');
                showBubble('Live2D ✨', 2000);
                console.log('[Live2D] 模型加载完成!');

            } catch (error) {
                console.error('[Live2D] 加载失败:', error);
                setLoadingText('加载失败: ' + error.message);
            }
        }

        function setupModel(m) {
            const scale = Math.min(window.innerWidth / m.width * 0.9, window.innerHeight / m.height * 0.9);
            m.scale.set(scale);
            m.x = window.innerWidth / 2;
            m.y = window.innerHeight / 2;
            m.anchor.set(0.5, 0.5);
            m.interactive = true;

            m.on('hit', (areas) => {
                console.log('[Live2D] Hit:', areas);
                m.motion(areas.includes('Head') ? 'TapHead' : 'TapBody') || m.motion('Idle');
                sendGesture('TAP', { part: areas[0] || 'body' });
            });

            document.addEventListener('pointermove', (e) => {
                if (!m) return;
                const r = app.view.getBoundingClientRect();
                m.focus((e.clientX - r.left) / r.width * 2 - 1, (e.clientY - r.top) / r.height * 2 - 1);
            });

            window.addEventListener('resize', () => {
                const s = Math.min(window.innerWidth / m.width * 0.9, window.innerHeight / m.height * 0.9);
                m.scale.set(s); m.x = window.innerWidth / 2; m.y = window.innerHeight / 2;
            });
        }

        function setLoadingText(text) {
            const el = document.getElementById('loading-text');
            if (el) el.textContent = text;
        }

        function showBubble(text, duration = 3000) {
            const b = document.getElementById('bubble');
            if (bubbleTimer) clearTimeout(bubbleTimer);
            b.textContent = text; b.classList.add('show');
            if (duration > 0) bubbleTimer = setTimeout(() => b.classList.remove('show'), duration);
        }

        function sendGesture(gesture, data = {}) {
            if (typeof uniapp !== 'undefined' && uniapp.sendDataToUni) {
                uniapp.sendDataToUni(100, JSON.stringify({ gesture, part: data.part, timestamp: Date.now() }));
            }
        }

        // 接收 uni-app 消息
        window.dataFromUniapp = function (type, msg) {
            console.log('[Live2D] 收到消息:', type);
            let data = msg;
            try { if (typeof msg === 'string' && msg.startsWith('{')) data = JSON.parse(msg); } catch (e) { }

            switch (type) {
                case 0: document.getElementById('bubble').classList.remove('show'); break;
                case 1: showBubble(typeof data === 'string' ? data : data.message || data.text); break;
                case 2: showBubble(typeof data === 'string' ? data : data.message); if (model) model.expression('angry'); break;
                case 10: if (model && data.motion) model.motion(data.motion); break;
                case 11: if (model && data.expression) model.expression(data.expression); break;
                case 200:
                    console.log('[Live2D] 收到模型数据, 文件数:', data.files?.length);
                    initApp();
                    if (data.files && data.files.length > 0) {
                        loadModelFromFiles(data.files, data.modelName);
                    }
                    break;
            }
        };

        window.addEventListener('DOMContentLoaded', () => {
            console.log('[Live2D] 页面加载完成, 等待模型数据');
            initApp();
        });
    </script>
</body>

</html>