<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pet Live2D</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body,
        html {
            width: 100%;
            height: 100%;
            background: transparent;
            overflow: hidden;
            font-family: sans-serif;
            user-select: none;
            pointer-events: none;
        }

        .container {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
            /* å†…å®¹é åº•éƒ¨ */
            pointer-events: none;
        }

        /* Live2D æ¸²æŸ“åŒºåŸŸå›ºå®šåœ¨åº•éƒ¨ï¼Œä¸éšçª—å£æ‰©å¤§ */
        #live2d-container {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 220px;
            /* å›ºå®šé«˜åº¦ï¼Œä¸ FLOAT_SIZES_LIVE2D.NORMAL.h ä¸€è‡´ */
            pointer-events: none;
        }

        /* canvas æœ¬èº«æ¥æ”¶ç‚¹å‡» */
        #live2d-container canvas {
            pointer-events: auto !important;
        }

        /* æ°”æ³¡åœ¨é¡¶éƒ¨æ˜¾ç¤º */
        .bubble {
            position: absolute;
            top: 5px;
            left: 50%;
            transform: translateX(-50%) translateY(-5px);
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.95) 0%, rgba(118, 75, 162, 0.95) 100%);
            color: #fff;
            padding: 8px 12px;
            border-radius: 12px;
            font-size: 12px;
            line-height: 1.5;
            max-width: 88%;
            min-width: 60px;
            max-height: 70px;
            overflow-y: auto;
            text-align: center;
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4), 0 0 20px rgba(118, 75, 162, 0.2);
            pointer-events: none;
            border: 1px solid rgba(255, 255, 255, 0.2);
            z-index: 100;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .bubble.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        /* æ„¤æ€’æ¨¡å¼ï¼ˆçº¢è‰²æ¸å˜ï¼‰ */
        .bubble.angry {
            background: linear-gradient(135deg, rgba(255, 87, 87, 0.95) 0%, rgba(200, 40, 80, 0.95) 100%);
            box-shadow: 0 4px 15px rgba(255, 87, 87, 0.4), 0 0 20px rgba(200, 40, 80, 0.2);
        }

        /* æ°”æ³¡å°å°¾å·´ï¼ˆæœä¸‹ï¼‰ */
        .bubble::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            border-width: 8px 8px 0;
            border-style: solid;
            border-color: rgba(118, 75, 162, 0.95) transparent transparent transparent;
        }

        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #00e676;
            font-size: 12px;
            text-align: center;
            z-index: 50;
        }

        #loading.hidden {
            display: none;
        }

        .spinner {
            width: 30px;
            height: 30px;
            border: 3px solid rgba(0, 230, 118, 0.3);
            border-top-color: #00e676;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* ç‚¹å‡»åé¦ˆæ•ˆæœ */
        .touch-effect {
            position: absolute;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(255, 102, 204, 0.4);
            animation: touchPulse 0.4s ease-out forwards;
            pointer-events: none;
        }

        @keyframes touchPulse {
            0% {
                transform: translate(-50%, -50%) scale(0);
                opacity: 1;
            }

            100% {
                transform: translate(-50%, -50%) scale(2);
                opacity: 0;
            }
        }
    </style>
</head>

<body>
    <div class="container" id="container">
        <!-- æ°”æ³¡åŒºåŸŸï¼ˆæ‚¬æµ®çª—æ‰©å¤§æ—¶æ˜¾ç¤ºï¼‰ -->
        <div class="bubble" id="bubble"></div>
        <div id="loading">
            <div class="spinner"></div>
            <div id="loading-text">ç­‰å¾…æ¨¡å‹æ•°æ®...</div>
        </div>
        <div id="live2d-container"></div>
    </div>

    <script src="./lib/live2dcubismcore.min.js"></script>
    <script src="./lib/live2d.min.js"></script>
    <script src="./lib/pixi.min.js"></script>
    <script src="./lib/cubism2.min.js"></script>
    <script src="./lib/cubism4.min.js"></script>

    <script>
        let app = null, model = null, bubbleTimer = null;

        function initApp() {
            if (app) return;
            app = new PIXI.Application({
                view: document.createElement('canvas'),
                resizeTo: window,
                backgroundAlpha: 0,
                antialias: true
            });
            document.getElementById('live2d-container').appendChild(app.view);
            console.log('[Live2D] PIXI åº”ç”¨å·²åˆ›å»º');
        }

        // Base64 Data URL è½¬ Blob
        function dataURLToBlob(dataURL) {
            const parts = dataURL.split(',');
            const mime = parts[0].match(/:(.*?);/)[1];
            const binary = atob(parts[1]);
            const array = new Uint8Array(binary.length);
            for (let i = 0; i < binary.length; i++) {
                array[i] = binary.charCodeAt(i);
            }
            return new Blob([array], { type: mime });
        }

        // ä»æ–‡ä»¶æ•°æ®åŠ è½½æ¨¡å‹ - ä½¿ç”¨ Object URL æ–¹æ¡ˆ
        async function loadModelFromFiles(filesData, modelName) {
            console.log('[Live2D] å¼€å§‹åŠ è½½æ¨¡å‹, å…±', filesData.length, 'ä¸ªæ–‡ä»¶');
            setLoadingText('æ­£åœ¨å¤„ç†æ–‡ä»¶...');

            try {
                // 1. ä¸ºæ¯ä¸ªæ–‡ä»¶åˆ›å»º Object URL å’Œè·¯å¾„æ˜ å°„
                const urlMap = {};
                let settingsJSON = null;
                let settingsPath = null;

                for (const f of filesData) {
                    const blob = dataURLToBlob(f.data);
                    const objectURL = URL.createObjectURL(blob);
                    urlMap[f.path] = objectURL;
                    console.log(`[Live2D] URLæ˜ å°„: ${f.path} -> ${objectURL.substring(0, 30)}...`);

                    // æ‰¾åˆ° settings æ–‡ä»¶
                    if (f.path.endsWith('.model.json') || f.path.endsWith('.model3.json')) {
                        settingsPath = f.path;
                        // è§£æ settings JSON
                        const text = atob(f.data.split(',')[1]);
                        settingsJSON = JSON.parse(text);
                        console.log('[Live2D] æ‰¾åˆ° settings æ–‡ä»¶:', f.path);
                    }
                }

                if (!settingsJSON) {
                    throw new Error('æœªæ‰¾åˆ° model.json æˆ– model3.json æ–‡ä»¶');
                }

                setLoadingText('æ­£åœ¨åŠ è½½æ¨¡å‹...');

                // 2. è®¾ç½® url å±æ€§ (è™šæ‹Ÿè·¯å¾„ï¼Œç”¨äºè§£æç›¸å¯¹è·¯å¾„)
                settingsJSON.url = settingsPath;

                // 3. åˆ›å»ºè‡ªå®šä¹‰ URL è§£æå™¨
                const customResolver = (settingsURL, path) => {
                    // è·å–åŸºç¡€ç›®å½•
                    const baseDir = settingsURL.substring(0, settingsURL.lastIndexOf('/') + 1);
                    const fullPath = baseDir + path;
                    const resolved = urlMap[fullPath] || urlMap[path];
                    console.log(`[Live2D] resolveURL: ${path} -> ${resolved ? 'found' : 'NOT FOUND'}`);
                    return resolved || path;
                };

                // 4. ä½¿ç”¨ Live2DModel åŠ è½½
                if (!PIXI?.live2d?.Live2DModel) {
                    throw new Error('Live2DModel æœªå®šä¹‰');
                }

                // åˆ›å»ºæ¨¡å‹è®¾ç½®å¹¶è¦†ç›– resolveURL
                const ModelSettingsClass = settingsPath.endsWith('.model3.json')
                    ? PIXI.live2d.Cubism4ModelSettings
                    : PIXI.live2d.Cubism2ModelSettings;

                const settings = new ModelSettingsClass(settingsJSON);

                // è¦†ç›– URL è§£ææ–¹æ³•
                const originalResolve = settings.resolveURL.bind(settings);
                settings.resolveURL = (path) => {
                    const resolved = urlMap[path] || customResolver(settingsPath, path);
                    return resolved;
                };

                console.log('[Live2D] å¼€å§‹åˆ›å»ºæ¨¡å‹...');
                model = await PIXI.live2d.Live2DModel.from(settings, {
                    autoInteract: false
                });

                setupModel(model);
                app.stage.addChild(model);
                document.getElementById('loading').classList.add('hidden');
                showBubble('Live2D âœ¨', 2000);
                console.log('[Live2D] æ¨¡å‹åŠ è½½å®Œæˆ!');

            } catch (error) {
                console.error('[Live2D] åŠ è½½å¤±è´¥:', error);
                setLoadingText('åŠ è½½å¤±è´¥: ' + error.message);
            }
        }

        // ========== éƒ¨ä½åŒºåŸŸæ£€æµ‹ ==========

        /**
         * æ ¹æ®ç‚¹å‡» Y åæ ‡åˆ¤æ–­éƒ¨ä½
         * @returns 'head' | 'body' | 'legs'
         */
        function getClickedPart(e, canvas) {
            const rect = canvas.getBoundingClientRect();
            const relativeY = (e.clientY - rect.top) / rect.height;

            // å¤´éƒ¨åŒºåŸŸ: ä¸Š 35%
            if (relativeY < 0.35) return 'head';
            // èº«ä½“åŒºåŸŸ: ä¸­é—´ 35%  
            if (relativeY < 0.70) return 'body';
            // è…¿éƒ¨åŒºåŸŸ: ä¸‹ 30%
            return 'legs';
        }

        /**
         * å‚æ•°æ¸å˜åŠ¨ç”»å·¥å…·å‡½æ•°
         * @param {object} model - Live2D æ¨¡å‹
         * @param {string} paramId - å‚æ•°ID
         * @param {number} from - èµ·å§‹å€¼
         * @param {number} to - ç›®æ ‡å€¼
         * @param {number} duration - åŠ¨ç”»æ—¶é•¿(ms)
         * @param {boolean} autoRevert - æ˜¯å¦è‡ªåŠ¨æ¢å¤
         */
        function animateParam(model, paramId, from, to, duration, autoRevert = true) {
            if (!model?.internalModel?.coreModel) return;

            const coreModel = model.internalModel.coreModel;
            const startTime = Date.now();

            const animate = () => {
                const elapsed = Date.now() - startTime;
                const progress = Math.min(elapsed / duration, 1);
                // ä½¿ç”¨ easeOut ç¼“åŠ¨
                const eased = 1 - Math.pow(1 - progress, 3);
                const value = from + (to - from) * eased;

                try {
                    coreModel.setParameterValueById(paramId, value);
                } catch (e) {
                    console.warn('[Live2D] å‚æ•°è®¾ç½®å¤±è´¥:', paramId, e);
                    return;
                }

                if (progress < 1) {
                    requestAnimationFrame(animate);
                } else if (autoRevert) {
                    // åŠ¨ç”»ç»“æŸåå»¶è¿Ÿæ¢å¤
                    setTimeout(() => {
                        animateParam(model, paramId, to, from, duration * 0.8, false);
                    }, 600);
                }
            };
            animate();
        }

        /**
         * æ’­æ”¾éƒ¨ä½å¯¹åº”çš„åŠ¨ç”»æ•ˆæœ (å¢å¼ºç‰ˆ)
         */
        function playPartAnimation(model, part) {
            console.log('[Live2D] æ’­æ”¾éƒ¨ä½åŠ¨ç”»:', part);

            // å…ˆåœæ­¢å½“å‰åŠ¨ä½œï¼Œè®©å‚æ•°ä¸è¢«è¦†ç›–
            try {
                if (model.internalModel && model.internalModel.motionManager) {
                    model.internalModel.motionManager.stopAllMotions();
                }
            } catch (e) {
                console.log('[Live2D] åœæ­¢åŠ¨ä½œå¤±è´¥(å¯å¿½ç•¥):', e);
            }

            switch (part) {
                case 'head':
                    // æ‘¸å¤´ â†’ è„¸çº¢ + ç¬‘çœ¼ + å¼€å¿ƒ (æ›´å¼ºçƒˆ)
                    animateParam(model, 'ParamCheek', 0, 1, 600);         // è„¸çº¢
                    animateParam(model, 'ParamEyeLSmile', 0, 1, 400);     // å·¦çœ¼ç¬‘
                    animateParam(model, 'ParamEyeRSmile', 0, 1, 400);     // å³çœ¼ç¬‘
                    animateParam(model, 'ParamMouthForm', 0, 1, 500);     // å¤§ç¬‘å˜´å‹
                    animateParam(model, 'ParamAngleZ', 0, -10, 300);      // æ­ªå¤´
                    showBubble('ğŸ¥° å˜¿å˜¿~', 2000);
                    break;

                case 'body':
                    // æˆ³èº«ä½“ â†’ ç¼©è‚© + çœ‰æ¯›å¾®åŠ¨ + èº«ä½“åä»°
                    animateParam(model, 'ParamShoulder', 0, 1, 400);       // ç¼©è‚©(æ»¡å€¼)
                    animateParam(model, 'ParamBrowLY', 0, 1, 350);         // å·¦çœ‰å¤§å¹…ä¸Šæ‰¬
                    animateParam(model, 'ParamBrowRY', 0, 1, 350);         // å³çœ‰å¤§å¹…ä¸Šæ‰¬
                    animateParam(model, 'ParamBodyAngleY', 0, -5, 300);    // èº«ä½“åä»°
                    animateParam(model, 'ParamMouthOpenY', 0, 0.5, 250);   // å¾®å¼ å˜´
                    showBubble('ğŸ˜³ åˆ«æˆ³~', 2000);
                    break;

                case 'legs':
                    // æˆ³è…¿ â†’ èº«ä½“å¤§å¹…æ‰­åŠ¨ + æƒŠè®¶è¡¨æƒ…
                    animateParam(model, 'ParamBodyAngleZ', 0, 15, 400);    // èº«ä½“å¤§å¹…å€¾æ–œ
                    animateParam(model, 'ParamBodyAngleX', 0, 10, 350);    // èº«ä½“è½¬å‘
                    animateParam(model, 'ParamBrowLY', 0, -1, 300);        // çœ‰æ¯›ä¸‹å‹(æ»¡å€¼)
                    animateParam(model, 'ParamBrowRY', 0, -1, 300);
                    animateParam(model, 'ParamMouthOpenY', 0, 1, 250);     // å¤§å¼ å˜´
                    animateParam(model, 'ParamEyeLOpen', 1, 1.3, 200);     // çå¤§çœ¼
                    animateParam(model, 'ParamEyeROpen', 1, 1.3, 200);
                    showBubble('ğŸ˜® å“å‘€!', 1500);
                    break;
            }

            // å»¶è¿Ÿåæ¢å¤ Idle åŠ¨ç”»
            setTimeout(() => {
                if (model) {
                    model.motion('Idle');
                }
            }, 1500);
        }

        // ========== æ¨¡å‹è®¾ç½® ==========

        function setupModel(m) {
            // ä½¿ç”¨å›ºå®šå®¹å™¨å¤§å°è®¡ç®—ç¼©æ”¾ï¼ˆä¸ FLOAT_SIZES_LIVE2D.NORMAL ä¸€è‡´ï¼‰
            const containerW = 130;
            const containerH = 220;
            const scale = Math.min(containerW / m.width * 0.9, containerH / m.height * 0.9);
            m.scale.set(scale);
            m.x = containerW / 2;
            m.y = containerH / 2;
            m.anchor.set(0.5, 0.5);
            m.interactive = true;

            // Live2D åŸç”Ÿ hit äº‹ä»¶ï¼ˆä¿ç•™ä½œä¸ºå¤‡ç”¨ï¼‰
            m.on('hit', (areas) => {
                console.log('[Live2D] Hit Areas:', areas);
            });

            // Canvas ç‚¹å‡»äº‹ä»¶ - ä½¿ç”¨åæ ‡åŒºåŸŸæ£€æµ‹
            const canvas = app.view;
            canvas.addEventListener('pointerdown', (e) => {
                console.log('[Live2D] ç‚¹å‡»åæ ‡:', e.clientX, e.clientY);
                createTouchEffect(e.clientX, e.clientY);

                if (m) {
                    // æ£€æµ‹ç‚¹å‡»éƒ¨ä½
                    const part = getClickedPart(e, canvas);
                    console.log('[Live2D] æ£€æµ‹åˆ°éƒ¨ä½:', part);

                    // æ’­æ”¾å¯¹åº”éƒ¨ä½çš„å‚æ•°åŠ¨ç”»
                    playPartAnimation(m, part);

                    // å‘é€æ‰‹åŠ¿äº‹ä»¶åˆ° uni-app
                    sendGesture('TAP', { part: part });
                }
            });

            // çœ¼ç¥è·Ÿéš
            document.addEventListener('pointermove', (e) => {
                if (!m) return;
                const r = canvas.getBoundingClientRect();
                m.focus((e.clientX - r.left) / r.width * 2 - 1, (e.clientY - r.top) / r.height * 2 - 1);
            });

            // æ¨¡å‹å¤§å°å›ºå®šï¼Œä¸éœ€è¦ resize å¤„ç†
        }

        // åˆ›å»ºç‚¹å‡»åé¦ˆæ•ˆæœ
        function createTouchEffect(x, y) {
            const effect = document.createElement('div');
            effect.className = 'touch-effect';
            effect.style.left = x + 'px';
            effect.style.top = y + 'px';
            document.getElementById('container').appendChild(effect);
            setTimeout(() => effect.remove(), 400);
        }

        function setLoadingText(text) {
            const el = document.getElementById('loading-text');
            if (el) el.textContent = text;
        }

        function showBubble(text, duration = 3000) {
            const b = document.getElementById('bubble');
            if (bubbleTimer) clearTimeout(bubbleTimer);
            b.textContent = text;
            b.classList.remove('angry');
            b.classList.add('show');
            if (duration > 0) bubbleTimer = setTimeout(() => b.classList.remove('show'), duration);
        }

        function sendGesture(gesture, data = {}) {
            if (typeof uniapp !== 'undefined' && uniapp.sendDataToUni) {
                uniapp.sendDataToUni(100, JSON.stringify({ gesture, part: data.part, timestamp: Date.now() }));
            }
        }

        // æ¥æ”¶ uni-app æ¶ˆæ¯
        window.dataFromUniapp = function (type, msg) {
            console.log('[Live2D] æ”¶åˆ°æ¶ˆæ¯:', type);
            let data = msg;
            try { if (typeof msg === 'string' && msg.startsWith('{')) data = JSON.parse(msg); } catch (e) { }

            switch (type) {
                case 0: document.getElementById('bubble').classList.remove('show'); break;
                case 1: showBubble(typeof data === 'string' ? data : data.message || data.text); break;
                case 2:
                    const b = document.getElementById('bubble');
                    b.classList.add('angry');
                    showBubble(typeof data === 'string' ? data : data.message);
                    if (model) model.expression('angry');
                    break;
                case 10: if (model && data.motion) model.motion(data.motion); break;
                case 11: if (model && data.expression) model.expression(data.expression); break;
                case 200:
                    console.log('[Live2D] æ”¶åˆ°æ¨¡å‹æ•°æ®, æ–‡ä»¶æ•°:', data.files?.length);
                    initApp();
                    if (data.files && data.files.length > 0) {
                        loadModelFromFiles(data.files, data.modelName);
                    }
                    break;
            }
        };

        window.addEventListener('DOMContentLoaded', () => {
            console.log('[Live2D] é¡µé¢åŠ è½½å®Œæˆ, ç­‰å¾…æ¨¡å‹æ•°æ®');
            initApp();
        });
    </script>
</body>

</html>